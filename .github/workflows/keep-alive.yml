name: Keep Render API Awake (silent)

on:
  schedule:
    - cron: "*/5 * * * *"        # every 5 minutes (UTC)
  workflow_dispatch:

permissions:
  contents: read

env:
  # Add one URL per line
  PING_URLS: |
    https://api.psspl.pawanssiddhi.in/health
    https://api.psspl.pawanssiddhi.in/api/public/properties?page=1&limit=1

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Even if any step returns non-zero, the job is still marked success
    continue-on-error: true

    steps:
      - name: Show target URLs
        run: echo "${{ env.PING_URLS }}"

      - name: Curl each URL (do not fail the job)
        id: pinger
        shell: bash
        run: |
          set -uo pipefail
          IFS=$'\n'
          failed_list=()
          for url in $PING_URLS; do
            echo "→ Pinging: $url"
            code=$(curl -sS -o /dev/null -w "%{http_code}" \
              --retry 3 --retry-all-errors --max-time 20 "$url") || code="000"
            if [[ "$code" =~ ^2[0-9]{2}$ ]]; then
              echo "✓ OK ($code) — $url"
            else
              echo "::warning::Ping failed ($code) — $url"
              failed_list+=("$url ($code)")
            fi
          done

          # Expose counts/urls as outputs but DO NOT exit non-zero
          echo "failed_count=${#failed_list[@]}" >> $GITHUB_OUTPUT
          {
            echo "failed_urls<<EOF"
            printf "%s\n" "${failed_list[@]}"
            echo "EOF"
          } >> $GITHUB_OUTPUT

      # Optional: Slack alert only (won’t fail workflow)
      - name: Slack alert if any URL failed (optional)
        if: ${{ steps.pinger.outputs.failed_count != '0' && env.SLACK_WEBHOOK_URL != '' }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          FAILED_URLS: ${{ steps.pinger.outputs.failed_urls }}
        run: |
          payload=$(jq -n --arg t "❗ Keep-Alive warnings:\n$FAILED_URLS" '{text: $t}')
          curl -sS -X POST -H 'Content-type: application/json' --data "$payload" "$SLACK_WEBHOOK_URL"
