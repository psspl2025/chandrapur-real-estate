name: Keep Render API Awake

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes (UTC)
  workflow_dispatch:        # allow manual run

permissions:
  contents: read

env:
  PING_URLS: |
    https://api.psspl.pawanssiddhi.in/health

jobs:
  ping:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Show target URLs
        run: echo "${{ env.PING_URLS }}"

      - name: Curl each URL
        shell: bash
        run: |
          set -euo pipefail
          IFS=$'\n'
          failed=0
          for url in $PING_URLS; do
            echo "→ Pinging: $url"
            # Do the request, capture HTTP code, retry on transient failures
            code=$(curl -sS -o /dev/null -w "%{http_code}" \
              --retry 3 --retry-all-errors --max-time 20 "$url") || true

            if [[ "$code" =~ ^2[0-9]{2}$ ]]; then
              echo "✓ OK ($code) — $url"
            else
              echo "✗ FAIL ($code) — $url"
              failed=$((failed+1))
            fi
          done

          if [[ $failed -gt 0 ]]; then
            echo "::error ::$failed URL(s) failed."
            exit 1
          fi
